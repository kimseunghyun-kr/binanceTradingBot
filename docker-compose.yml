
services:
  # ───────────────────────────
  # FastAPI application
  # ───────────────────────────
  app:
    profiles: ["app"]
    build: .
    container_name: tradingbot_app
    restart: unless-stopped
    env_file: [.env.development]
    group_add:
      - "0"               # ← gives celery rw on /var/run/docker.sock
    environment:
      MONGO_URI_MASTER: "mongodb://mongo1:27017/?replicaSet=rs0"
      MONGO_URI_SLAVE:  "mongodb://mongo2:27017/?replicaSet=rs0&readPreference=secondaryPreferred"
      REDIS_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
      POSTGRES_DSN: "postgresql://postgres:postgres@postgres:5432/trading"
      PYCHARM_ATTACH: "1"
      DOCKER_HOST: "unix:///var/run/docker.sock"
    ports: ["8000:8000"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mongo1:  {condition: service_healthy}
      mongo2:  {condition: service_healthy}
      redis:   {condition: service_started}
      postgres: {condition: service_started}
      mongo_init: {condition: service_completed_successfully}
    command: >
      python -m uvicorn KwontBot:app --host 0.0.0.0 --reload
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock          # ← host daemon
    networks: [default]

  # ───────────────────────────
  # Celery worker
  # ───────────────────────────
  worker:
    profiles: ["app"]
    build: .
    container_name: tradingbot_worker
    restart: unless-stopped
    command: ["python", "-m", "celery", "-A", "app.core.celery_app", "worker", "--concurrency=4"]
    user: "celery"
    group_add:
      - "0"               # ← gives celery rw on /var/run/docker.sock
    env_file: [.env.development]
    environment:
      MONGO_URI_MASTER: "mongodb://mongo1:27017/?replicaSet=rs0"
      MONGO_URI_SLAVE:  "mongodb://mongo2:27017/?replicaSet=rs0&readPreference=secondaryPreferred"
      REDIS_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
      POSTGRES_DSN: "postgresql://postgres:postgres@postgres:5432/trading"
      PYCHARM_ATTACH: "1"
      PYCHARM_HOST: "host.docker.internal"
      PYCHARM_PORT: "5679"
      DOCKER_HOST: "unix:///var/run/docker.sock"
      DOCKER_NETWORK: "${COMPOSE_PROJECT_NAME:-binancetradingbot}_default"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mongo1:  {condition: service_healthy}
      mongo2:  {condition: service_healthy}
      redis:   {condition: service_started}
      postgres: {condition: service_started}
      mongo_init: {condition: service_completed_successfully}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock          # ← host daemon
    networks: [default]

  # ───────────────────────────
  # Infrastructure
  # ───────────────────────────
  redis:
    profiles: ["db"]
    image: redis:6-alpine
    container_name: tradingbot_redis
    restart: unless-stopped
    ports: ["6379:6379"]
    networks: [default]

  mongo1:
    profiles: ["db"]
    image: mongo:6
    container_name: tradingbot_mongo1
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports: ["27017:27017"]
    volumes: [mongo1_data:/data/db]
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.adminCommand(\"ping\").ok' | grep 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [default]

  mongo2:
    profiles: ["db"]
    image: mongo:6
    container_name: tradingbot_mongo2
    command: ["--replSet", "rs0", "--bind_ip_all"]
    ports: ["27018:27017"]
    volumes: [mongo2_data:/data/db]
    depends_on:
      mongo1: {condition: service_started}
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.adminCommand(\"ping\").ok' | grep 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [default]

  mongo_init:
    image: mongo:6
    profiles: ["db"]
    depends_on:
      mongo1: {condition: service_healthy}
      mongo2: {condition: service_healthy}
    restart: "no"
    volumes:
      - ./mongo_init_simple.sh:/usr/local/bin/mongo_init_simple.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/mongo_init_simple.sh"]
    networks: [default]

  postgres:
    profiles: ["db"]
    image: postgres:13-alpine
    container_name: tradingbot_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "trading"
    ports: ["5432:5432"]
    volumes: [pg_data:/var/lib/postgresql/data]
    command: ["postgres", "-c", "max_connections=200", "-c", "shared_buffers=256MB"]
    networks: [default]

  nginx:
    profiles: ["app"]
    image: nginx:alpine
    container_name: tradingbot_nginx
    depends_on:
      app: {condition: service_started}
    ports: ["80:80"]
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [default]

# ───────────────────────────
# Volumes
# ───────────────────────────
volumes:
  mongo1_data:
  mongo2_data:
  pg_data:
  binancetradingbot_docker_data: { }


# default bridge network only
networks:
  default:
    driver: bridge

